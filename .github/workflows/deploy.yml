name: Deploy to Prefect Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted
    environment: servidor_local

    steps:
      - name: Validate required configuration
        run: |
          # Check for VM_HOST (can be in secrets or variables)
          VM_HOST="${{ secrets.VM_HOST }}"
          if [ -z "$VM_HOST" ]; then
            VM_HOST="${{ vars.VM_HOST }}"
          fi

          # Check for VM_USER (can be in secrets or variables)
          VM_USER="${{ secrets.VM_USER }}"
          if [ -z "$VM_USER" ]; then
            VM_USER="${{ vars.VM_USER }}"
          fi

          # Check for VM_PASSWORD (should be in secrets)
          VM_PASSWORD="${{ secrets.VM_PASSWORD }}"

          if [ -z "$VM_HOST" ]; then
            echo "ERROR: VM_HOST is not set!"
            echo "Please configure VM_HOST in GitHub environment 'servidor_local'"
            echo "Go to: Settings > Environments > servidor_local > Add variable or secret"
            exit 1
          fi

          if [ -z "$VM_USER" ]; then
            echo "ERROR: VM_USER is not set!"
            exit 1
          fi

          if [ -z "$VM_PASSWORD" ]; then
            echo "ERROR: VM_PASSWORD is not set!"
            exit 1
          fi

          echo "All required configuration is set."
          echo "VM_HOST: $VM_HOST"
          echo "VM_USER: $VM_USER"

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get changed files in flows directory
        id: changed-flows
        run: |
          # Get list of changed Python files in flows directory
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep '^flows/.*\.py$' || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "No Python files changed in flows directory"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Changed files:"
            echo "$CHANGED_FILES"

            # Convert newlines to commas for easier processing
            CHANGED_FILES_LIST=$(echo "$CHANGED_FILES" | tr '\n' ',' | sed 's/,$//')
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "files=$CHANGED_FILES_LIST" >> $GITHUB_OUTPUT
          fi

      - name: Install sshpass
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass

      - name: Setup SSH config
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.VM_HOST || vars.VM_HOST }} >> ~/.ssh/known_hosts || true
          echo "StrictHostKeyChecking no" >> ~/.ssh/config

      - name: Deploy to VM
        env:
          VM_HOST: ${{ secrets.VM_HOST || vars.VM_HOST }}
          VM_USER: ${{ secrets.VM_USER || vars.VM_USER }}
          VM_PASSWORD: ${{ secrets.VM_PASSWORD }}
          VM_PROJECT_PATH: /opt/prefect-server
        run: |
          # Create project directory if it doesn't exist
          sshpass -p "$VM_PASSWORD" ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $VM_USER@$VM_HOST "mkdir -p $VM_PROJECT_PATH"

          # Sync files to VM (excluding git, pycache, and other unnecessary files)
          sshpass -p "$VM_PASSWORD" rsync -avz --delete \
            --exclude '.git' \
            --exclude '__pycache__' \
            --exclude '*.pyc' \
            --exclude '.env' \
            --exclude 'venv' \
            --exclude '.idea' \
            ./ $VM_USER@$VM_HOST:$VM_PROJECT_PATH/

          echo "Files deployed successfully to $VM_HOST:$VM_PROJECT_PATH"

      - name: Restart Docker containers
        env:
          VM_HOST: ${{ secrets.VM_HOST || vars.VM_HOST }}
          VM_USER: ${{ secrets.VM_USER || vars.VM_USER }}
          VM_PASSWORD: ${{ secrets.VM_PASSWORD }}
          VM_PROJECT_PATH: /opt/prefect-server
        run: |
          sshpass -p "$VM_PASSWORD" ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $VM_USER@$VM_HOST "cd $VM_PROJECT_PATH && \
            if [ ! -f .env ]; then \
              echo 'Warning: .env file not found. Please ensure environment variables are configured.'; \
            fi && \
            docker-compose down && \
            docker-compose up -d --build && \
            echo 'Docker containers restarted successfully'"

      - name: Wait for containers to be ready
        if: steps.changed-flows.outputs.has_changes == 'true'
        run: |
          echo "Waiting 30 seconds for containers to initialize..."
          sleep 30

      - name: Deploy changed flows
        if: steps.changed-flows.outputs.has_changes == 'true'
        env:
          VM_HOST: ${{ secrets.VM_HOST || vars.VM_HOST }}
          VM_USER: ${{ secrets.VM_USER || vars.VM_USER }}
          VM_PASSWORD: ${{ secrets.VM_PASSWORD }}
          VM_PROJECT_PATH: /opt/prefect-server
          CHANGED_FILES: ${{ steps.changed-flows.outputs.files }}
        run: |
          # Convert comma-separated files to space-separated for easier iteration
          FILES_TO_DEPLOY=$(echo "$CHANGED_FILES" | tr ',' ' ')

          echo "Deploying flows to Prefect..."

          for file in $FILES_TO_DEPLOY; do
            echo "Deploying: $file"

            sshpass -p "$VM_PASSWORD" ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $VM_USER@$VM_HOST \
              "cd $VM_PROJECT_PATH && \
              if [ -f $file ]; then \
                docker exec prefect-client python /opt/prefect/$file && \
                echo 'Successfully deployed: $file'; \
              else \
                echo 'Warning: File not found: $file'; \
              fi"

            if [ $? -ne 0 ]; then
              echo "Error deploying: $file"
              exit 1
            fi
          done

          echo "All flows deployed successfully!"

      - name: Deployment summary
        if: always()
        run: |
          echo "Deployment completed!"
          echo "Target: ${{ secrets.VM_HOST || vars.VM_HOST }}"
          echo "Project path: /opt/prefect-server"

          if [ "${{ steps.changed-flows.outputs.has_changes }}" == "true" ]; then
            echo "Deployed flows:"
            echo "${{ steps.changed-flows.outputs.files }}" | tr ',' '\n'
          else
            echo "No flow files were changed in this commit"
          fi